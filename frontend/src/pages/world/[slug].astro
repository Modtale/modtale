---
import BaseLayout from '../../layouts/BaseLayout.astro';
import App from '../../App';
import { extractId } from '../../utils/slug';
import { isBotUserAgent } from '../../utils/seo';
import { generateProjectMeta } from '../../utils/meta';
import { ROUTE_SEO } from '../../data/seo-constants';

const { slug } = Astro.params;
const id = extractId(slug || '');
const path = Astro.url.pathname;
const API_URL = import.meta.env.PUBLIC_API_URL;

const userAgent = Astro.request.headers.get('user-agent') || '';
const isBot = isBotUserAgent(userAgent);

let modData = null;
let title = ROUTE_SEO['/worlds'].title;
let description = ROUTE_SEO['/worlds'].description;
let image = undefined;
let jsonLd = undefined;

if (isBot) {
    try {
        const res = await fetch(`${API_URL}/worlds/${id}`);
        if (res.ok) {
            modData = await res.json();
            modData.classification = 'SAVE';

            const meta = generateProjectMeta(modData);
            if (meta) {
                title = meta.title;
                description = meta.description;
            }

            if (modData.imageUrl) {
                image = modData.imageUrl.startsWith('/api') ? `${API_URL.replace('/api', '')}${modData.imageUrl}` : modData.imageUrl;
            }

            jsonLd = {
                "@context": "https://schema.org",
                "@type": "SoftwareApplication",
                "name": modData.title,
                "description": meta?.description || description,
                "image": image,
                "author": { "@type": "Person", "name": modData.author || 'Unknown' },
                "applicationCategory": "GameApplication",
                "operatingSystem": "Windows, macOS, Linux",
                "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
                "aggregateRating": (modData.rating && modData.rating > 0) ? {
                    "@type": "AggregateRating",
                    "ratingValue": modData.rating,
                    "ratingCount": Math.max(1, modData.reviews ? modData.reviews.length : 0)
                } : undefined
            };
        }
    } catch (e) { console.error("[SSR] Fetch Error:", e); }
}
---

<BaseLayout title={title} description={description} image={image} jsonLd={jsonLd} initialData={modData}>
    <App client:load initialPath={path} ssrData={modData} />
</BaseLayout>