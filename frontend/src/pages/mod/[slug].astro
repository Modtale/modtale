---
import BaseLayout from '../../layouts/BaseLayout.astro';
import App from '../../App';
import { extractId } from '../../utils/slug';
import { isBotUserAgent } from '../../utils/seo';
import { generateProjectMeta } from '../../utils/meta';
import { DEFAULT_SEO } from '../../data/seo-constants';

const { slug } = Astro.params;
const id = extractId(slug || '');
const path = Astro.url.pathname;

const API_URL = import.meta.env.PUBLIC_API_URL || 'https://api.modtale.net/api/v1';

const userAgent = Astro.request.headers.get('user-agent') || '';
const isBot = isBotUserAgent(userAgent);

let modData = null;
let title = "Modtale - Hytale Mods";
let description = "Discover and download Hytale mods.";
let image = undefined;
let jsonLd = undefined;

if (isBot) {
    try {
        console.log(`[SSR] Bot detected (${userAgent}). Fetching data for ${id}...`);
        const res = await fetch(`${API_URL}/projects/${id}`);

        if (res.ok) {
            modData = await res.json();

            const meta = generateProjectMeta(modData);
            if (meta) {
                title = meta.title;
                description = meta.description;
            }

            if (modData.imageUrl) {
                image = modData.imageUrl.startsWith('/api') ? `${API_URL.replace('/api', '')}${modData.imageUrl}` : modData.imageUrl;
            }

            jsonLd = {
                "@context": "https://schema.org",
                "@type": "SoftwareApplication",
                "name": modData.title,
                "description": meta?.description || description,
                "image": image,
                "author": { "@type": "Person", "name": modData.author || 'Unknown' },
                "applicationCategory": "GameApplication",
                "operatingSystem": "Windows, macOS, Linux",
                "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
                "aggregateRating": modData.rating > 0 ? {
                    "@type": "AggregateRating",
                    "ratingValue": modData.rating,
                    "ratingCount": Math.max(1, modData.reviews ? modData.reviews.length : 0)
                } : undefined
            };
        }
    } catch (e) {
        console.error("[SSR] Fetch Error:", e);
    }
}
---

<BaseLayout title={title} description={description} image={image} jsonLd={jsonLd} initialData={modData}>
    <App client:load initialPath={path} ssrData={modData} />
</BaseLayout>