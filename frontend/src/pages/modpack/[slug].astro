---
import BaseLayout from '../../layouts/BaseLayout.astro';
import App from '../../App';
import { extractId } from '../../utils/slug';
import { isBotUserAgent } from '../../utils/seo';

const { slug } = Astro.params;
const id = extractId(slug || '');
const path = Astro.url.pathname;
const API_URL = import.meta.env.PUBLIC_API_URL || 'https://api.modtale.net/api/v1';

const userAgent = Astro.request.headers.get('user-agent') || '';
const isBot = isBotUserAgent(userAgent);

let modData = null;
let title = "Hytale Modpacks - Modtale";
let description = "Discover curated Hytale modpacks.";
let image = undefined;
let jsonLd = null;

if (isBot) {
    try {
        const res = await fetch(`${API_URL}/modpacks/${id}`);
        if (res.ok) {
            modData = await res.json();
            modData.classification = 'MODPACK';

            title = `${modData.title} | Modtale Modpacks`;
            const downloads = (modData.downloadCount || 0).toLocaleString();
            const author = modData.author || 'Unknown';
            const statsLine = `â¬‡ï¸ ${downloads}  ðŸ“¦ Modpack  ðŸ‘¤ ${author}`;

            let baseDesc = modData.about || (modData.description ? modData.description.replace(/[#*_\[\]`]/g, '').substring(0, 150) + '...' : "");
            description = `${baseDesc} â€” ${statsLine}`;

            if (modData.imageUrl) {
                image = modData.imageUrl.startsWith('/api') ? `${API_URL.replace('/api', '')}${modData.imageUrl}` : modData.imageUrl;
            }

            jsonLd = {
                "@context": "https://schema.org",
                "@type": "SoftwareApplication",
                "name": modData.title,
                "description": baseDesc,
                "image": image,
                "author": { "@type": "Person", "name": author },
                "applicationCategory": "GameApplication",
                "operatingSystem": "Windows, macOS, Linux",
                "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
                "aggregateRating": modData.rating > 0 ? {
                    "@type": "AggregateRating",
                    "ratingValue": modData.rating,
                    "ratingCount": Math.max(1, modData.reviews ? modData.reviews.length : 0)
                } : undefined
            };
        }
    } catch (e) { console.error("[SSR] Fetch Error:", e); }
}
---

<BaseLayout title={title} description={description} image={image} jsonLd={jsonLd} initialData={modData}>
    <App client:load initialPath={path} ssrData={modData} />
</BaseLayout>