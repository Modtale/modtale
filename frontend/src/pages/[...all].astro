---
import BaseLayout from '../layouts/BaseLayout.astro';
import App from '../App';
import { extractId, getProjectUrl } from '../utils/slug';
import { isBotUserAgent } from '../utils/seo';
import { DEFAULT_SEO, ROUTE_SEO } from '../data/seo-constants';
import { generateProjectMeta } from '../utils/meta';
import { generateItemListSchema, generateBreadcrumbSchema, getBreadcrumbsForClassification } from '../utils/schema';

const { all } = Astro.params;
const path = Astro.url.pathname;
const cleanPath = path.replace(/\/$/, "");

const API_URL = import.meta.env.PUBLIC_API_URL || 'https://api.modtale.net/api/v1';

if (cleanPath === '/mods') {
    return Astro.redirect('/', 301);
}

let title = DEFAULT_SEO.title;
let description = DEFAULT_SEO.description;
let keywords = DEFAULT_SEO.keywords;
let image = "https://modtale.net/assets/favicon.svg";
let jsonLd: any = undefined;
let initialData = null;

if (ROUTE_SEO[cleanPath]) {
    const seo = ROUTE_SEO[cleanPath];
    title = seo.title;
    description = seo.description;
    if (seo.keywords) keywords = seo.keywords;
}

const websiteSchema = {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Modtale",
    "url": "https://modtale.net/"
};

if (cleanPath === '' || cleanPath === '/') {
    jsonLd = websiteSchema;
}

const userAgent = Astro.request.headers.get('user-agent');
const isBot = isBotUserAgent(userAgent);
const id = extractId(all || '');

if (isBot) {
    const isProjectRoute = cleanPath.startsWith('/mod/') || cleanPath.startsWith('/modpack/') || cleanPath.startsWith('/world/');

    if (id && isProjectRoute) {
        try {
            console.log(`[SSR] Bot detected on project route (${id}). Fetching details...`);
            const res = await fetch(`${API_URL}/projects/${id}`);

            if (res.ok) {
                const modData = await res.json();

                const canonicalUrl = getProjectUrl(modData);
                if (cleanPath !== canonicalUrl.replace(/\/$/, "")) {
                    console.log(`[SEO] Bot Redirect: ${cleanPath} -> ${canonicalUrl}`);
                    return Astro.redirect(canonicalUrl, 301);
                }

                initialData = modData;

                const meta = generateProjectMeta(modData);
                if (meta) {
                    title = meta.title;
                    description = meta.description;
                }

                if (modData.imageUrl) {
                    image = modData.imageUrl.startsWith('/api') ? `${API_URL.replace('/api', '')}${modData.imageUrl}` : modData.imageUrl;
                }

                const appSchema = {
                    "@context": "https://schema.org",
                    "@type": "SoftwareApplication",
                    "name": modData.title,
                    "description": meta?.description || description,
                    "image": image,
                    "author": { "@type": "Person", "name": modData.author || 'Unknown' },
                    "applicationCategory": "GameApplication",
                    "operatingSystem": "Windows, macOS, Linux",
                    "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
                    "aggregateRating": modData.rating > 0 ? {
                        "@type": "AggregateRating",
                        "ratingValue": modData.rating,
                        "ratingCount": Math.max(1, modData.reviews ? modData.reviews.length : 0)
                    } : undefined
                };

                const crumbs = getBreadcrumbsForClassification(modData.classification || 'PLUGIN');
                const fullCrumbs = [...crumbs, { name: modData.title, url: canonicalUrl }];
                const breadcrumbSchema = generateBreadcrumbSchema(fullCrumbs);

                jsonLd = [appSchema, breadcrumbSchema];
            }
        } catch (e) {
            console.error("[SSR] Bot Fetch Error:", e);
        }
    } else {
        try {
            let classification = null;
            let isHome = false;

            if (cleanPath === '/plugins') classification = 'PLUGIN';
            else if (cleanPath === '/modpacks') classification = 'MODPACK';
            else if (cleanPath === '/worlds') classification = 'SAVE';
            else if (cleanPath === '/art') classification = 'ART';
            else if (cleanPath === '/data') classification = 'DATA';
            else if (cleanPath === '' || cleanPath === '/') {
                classification = 'ALL';
                isHome = true;
            }

            if (classification) {
                const endpoint = classification === 'ALL'
                    ? `${API_URL}/projects?size=12&sort=relevance`
                    : `${API_URL}/projects?classification=${classification}&size=12&sort=relevance`;

                const res = await fetch(endpoint);

                if (res.ok) {
                    const data = await res.json();
                    const items = data.content || [];

                    const listSchema = generateItemListSchema(items);
                    const crumbs = isHome ? [] : getBreadcrumbsForClassification(classification);
                    const breadcrumbSchema = isHome ? null : generateBreadcrumbSchema(crumbs);

                    const schemas = [];
                    if (isHome) schemas.push(websiteSchema);
                    if (listSchema) schemas.push(listSchema);
                    if (breadcrumbSchema) schemas.push(breadcrumbSchema);

                    if (schemas.length > 0) jsonLd = schemas;
                }
            }
        } catch (e) {
            console.error("[SSR] Bot List Fetch Error:", e);
        }
    }
}
---

<BaseLayout title={title} description={description} keywords={keywords} image={image} jsonLd={jsonLd} initialData={initialData}>
    <App client:load initialPath={path} ssrData={initialData} />
</BaseLayout>