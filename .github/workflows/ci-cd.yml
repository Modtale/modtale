name: Modtale CI/CD

on:
  push:
    branches:
      - main
      - develop
      - '*'

env:
  PROJECT_ID: gen-lang-client-0244308719
  REGION: us-central1

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - uses: actions/checkout@v4

      - name: Configure Environment
        id: config
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "Detected branch: $BRANCH_NAME"
          
          if [ "$BRANCH_NAME" = "main" ]; then
            echo "ENV_TYPE=prod" >> $GITHUB_ENV
            echo "BACKEND_SERVICE=modtale-backend" >> $GITHUB_ENV
            echo "FRONTEND_SERVICE=modtale-frontend" >> $GITHUB_ENV
            echo "DB_NAME=modtale" >> $GITHUB_ENV
            echo "SEEDING_ENABLED=false" >> $GITHUB_ENV
            echo "FIXED_BACKEND_URL=https://api.modtale.net/api/v1" >> $GITHUB_ENV
            echo "FRONTEND_DOMAIN=https://modtale.net" >> $GITHUB_ENV
            echo "TAG=latest" >> $GITHUB_ENV
            echo "R2_BUCKET_NAME=modtale-binaries" >> $GITHUB_ENV
            echo "R2_PUBLIC_DOMAIN=https://cdn.modtale.net" >> $GITHUB_ENV
            
          elif [ "$BRANCH_NAME" = "develop" ]; then
            echo "ENV_TYPE=dev" >> $GITHUB_ENV
            echo "BACKEND_SERVICE=modtale-backend-dev" >> $GITHUB_ENV
            echo "FRONTEND_SERVICE=modtale-frontend-dev" >> $GITHUB_ENV
            echo "DB_NAME=modtale-dev" >> $GITHUB_ENV
            echo "SEEDING_ENABLED=true" >> $GITHUB_ENV
            echo "FRONTEND_DOMAIN=https://dev.modtale.net" >> $GITHUB_ENV
            echo "TAG=dev" >> $GITHUB_ENV
            echo "R2_BUCKET_NAME=modtale-dev" >> $GITHUB_ENV
            echo "R2_PUBLIC_DOMAIN=https://dev-cdn.modtale.net" >> $GITHUB_ENV
            
          else
            SLUG=$(echo $BRANCH_NAME | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c 1-20 | sed 's/-$//')
            echo "ENV_TYPE=preview" >> $GITHUB_ENV
            echo "BACKEND_SERVICE=modtale-backend-$SLUG" >> $GITHUB_ENV
            echo "FRONTEND_SERVICE=modtale-frontend-$SLUG" >> $GITHUB_ENV
            echo "DB_NAME=modtale-$SLUG" >> $GITHUB_ENV
            echo "SEEDING_ENABLED=true" >> $GITHUB_ENV
            echo "TAG=$SLUG" >> $GITHUB_ENV
            echo "R2_BUCKET_NAME=modtale-dev" >> $GITHUB_ENV
            echo "R2_PUBLIC_DOMAIN=https://dev-cdn.modtale.net" >> $GITHUB_ENV
          fi

      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Build and Deploy Backend
        run: |
          cd backend
          gcloud builds submit --tag gcr.io/$PROJECT_ID/modtale-backend:${{ env.TAG }} .
          
          CMD="gcloud run deploy ${{ env.BACKEND_SERVICE }} \
            --image gcr.io/$PROJECT_ID/modtale-backend:${{ env.TAG }} \
            --region $REGION \
            --allow-unauthenticated \
            --update-env-vars MONGODB_DATABASE_NAME=${{ env.DB_NAME }} \
            --update-env-vars APP_SEEDING_ENABLED=${{ env.SEEDING_ENABLED }} \
            --update-env-vars APP_SEEDING_SOURCE_DB=modtale \
            --update-env-vars APP_WARDEN_URL=${{ secrets.WARDEN_URL }} \
            --update-env-vars FRONTEND_URL=placeholder \
            --update-env-vars R2_BUCKET_NAME=${{ env.R2_BUCKET_NAME }} \
            --update-env-vars R2_PUBLIC_DOMAIN=${{ env.R2_PUBLIC_DOMAIN }}"

          if [ "${{ env.ENV_TYPE }}" != "prod" ]; then
            CMD="$CMD --update-env-vars MONGODB_URI=${{ secrets.MONGODB_URI }}"
            CMD="$CMD --update-env-vars R2_ACCESS_KEY=${{ secrets.R2_ACCESS_KEY }}"
            CMD="$CMD --update-env-vars R2_SECRET_KEY=${{ secrets.R2_SECRET_KEY }}"
            CMD="$CMD --update-env-vars R2_ENDPOINT=${{ secrets.R2_ENDPOINT }}"
            CMD="$CMD --update-env-vars SMTP_HOST=${{ secrets.SMTP_HOST }}"
            CMD="$CMD --update-env-vars SMTP_USERNAME=${{ secrets.SMTP_USERNAME }}"
            CMD="$CMD --update-env-vars SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}"
            CMD="$CMD --update-env-vars GITHUB_CLIENT_ID=${{ secrets.GITHUB_CLIENT_ID }}"
            CMD="$CMD --update-env-vars GITHUB_CLIENT_SECRET=${{ secrets.GITHUB_CLIENT_SECRET }}"
            CMD="$CMD --update-env-vars GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}"
            CMD="$CMD --update-env-vars GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}"
          fi

          CMD="$CMD --format=value(status.url)"
          
          eval $CMD > backend_url.txt

      - name: Determine API URL
        run: |
          if [ "${{ env.ENV_TYPE }}" = "prod" ]; then
            echo "API_URL=${{ env.FIXED_BACKEND_URL }}" >> $GITHUB_ENV
          else
            echo "API_URL=$(cat backend/backend_url.txt)/api/v1" >> $GITHUB_ENV
          fi

      - name: Build and Deploy Frontend
        run: |
          cd frontend
          gcloud builds submit \
            --config=cloudbuild.yml \
            --substitutions=_PUBLIC_API_URL=${{ env.API_URL }},_TAG=${{ env.TAG }} .
          
          gcloud run deploy ${{ env.FRONTEND_SERVICE }} \
            --image gcr.io/$PROJECT_ID/modtale-frontend:${{ env.TAG }} \
            --region $REGION \
            --allow-unauthenticated \
            --set-env-vars PUBLIC_API_URL=${{ env.API_URL }} \
            --format="value(status.url)" > frontend_url.txt

      - name: Determine Frontend URL
        run: |
          if [ "${{ env.ENV_TYPE }}" = "preview" ]; then
            echo "FINAL_FRONTEND_URL=$(cat frontend/frontend_url.txt)" >> $GITHUB_ENV
          else
            echo "FINAL_FRONTEND_URL=${{ env.FRONTEND_DOMAIN }}" >> $GITHUB_ENV
          fi

      - name: Update Backend CORS
        run: |
          gcloud run services update ${{ env.BACKEND_SERVICE }} \
            --region $REGION \
            --update-env-vars FRONTEND_URL=${{ env.FINAL_FRONTEND_URL }}

      - name: Map Dev Domain
        if: env.ENV_TYPE == 'dev'
        continue-on-error: true
        run: |
          gcloud beta run domain-mappings create \
            --service ${{ env.FRONTEND_SERVICE }} \
            --domain dev.modtale.net \
            --region $REGION || echo "Mapping likely exists."
